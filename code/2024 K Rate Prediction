library(data.table)
library(dplyr)

k <- read.csv("C:/Users/me/Documents/JobApps/Phillies Senior Quantitative Analyst/k.csv")
#Fangraphs custom export with Stuff+
stuff <- read.csv("C:/Users/me/Documents/JobApps/Phillies Senior Quantitative Analyst/StuffPlus.csv")

#merge Stuff+ with the given table
stats <- merge(k, stuff,  all.x=TRUE)
#drop all players without stats in 2024
stats <- stats %>%
  group_by(PlayerId) %>%
  filter(any(Season == 2024)) %>%
  ungroup()

#reformatting to wide table
stats2 <- melt(as.data.table(stats), id.vars=c("PlayerId", "Name", "MLBAMID"),
               measure.vars=c("Age", "TBF", "K.", "Stuff."))
stats_wide <- dcast(stats2, PlayerId+Name ~ Season+variable)

###
#adding columns to fill in missing data
#K rate
stats_wide$last_k <- stats_wide$'2023_K.'
stats_wide$last_k[is.na(stats_wide$last_k)] <- 
  stats_wide$'2022_K.'[is.na(stats_wide$last_k)]
stats_wide$last_k[is.na(stats_wide$last_k)] <- 
  stats_wide$'2021_K.'[is.na(stats_wide$last_k)]
#if no other data for this player, replace with the mean k rate 
# to at least predict something
stats_wide$last_k[is.na(stats_wide$last_k)] <- 
  mean(stats_wide$'2023_K.', na.rm=TRUE)

#Stuff+
stats_wide$last_stuff <- stats_wide$'2023_Stuff.'
stats_wide$last_stuff[is.na(stats_wide$last_stuff)] <- 
  stats_wide$'2022_Stuff.'[is.na(stats_wide$last_stuff)]
stats_wide$last_stuff[is.na(stats_wide$last_stuff)] <- 
  stats_wide$'2021_Stuff.'[is.na(stats_wide$last_stuff)]
#if no other data for this player, replace with the mean Stuff 
# to at least predict something
stats_wide$last_stuff[is.na(stats_wide$last_stuff)] <- 
  mean(stats_wide$'2023_Stuff.', na.rm=TRUE)

#3 year average k rate
stats_wide <- stats_wide %>% 
  mutate(mean_k = rowMeans(select(.,'2021_K.', '2022_K.', '2023_K.'), na.rm=TRUE))
#if no other data for this player, replace with the mean k rate
# to at least predict something
stats_wide$mean_k[is.nan(stats_wide$mean_k)] <- 
  mean(stats_wide$mean_k, na.rm=TRUE)

#Baseline prediction: last recorded player K rate
predict_last_k <- lm(stats_wide$'2024_K.' ~ stats_wide$last_k)
rmse_last_k <- sqrt(c(crossprod(predict_last_k$residuals)) / 
                      length(predict_last_k$residuals))
#.041

#Baseline prediction: last recorded player Stuff+ 
predict_last_stuff <- lm(stats_wide$'2024_K.' ~ stats_wide$last_stuff)
rmse_last_stuff <- sqrt(c(crossprod(predict_last_stuff$residuals)) / 
                      length(predict_last_stuff$residuals))
#.0476

#Baseline prediction: player 3 year average k rate
predict_mean_k <- lm(stats_wide$'2024_K.' ~ stats_wide$mean_k)
rmse_mean_k <- sqrt(c(crossprod(predict_mean_k$residuals)) / 
                          length(predict_mean_k$residuals))
#.041
#plot
plot(predict_mean_k)

